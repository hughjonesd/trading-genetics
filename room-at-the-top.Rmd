---
title: "Trading social status for genetics in marriage markets: evidence from UK Biobank"
author: David Hugh-Jones, Oana Borcan & Abdel Abdellaoui
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2:
    toc: false
    latex_engine: xelatex
    number_sections: false
editor_options: 
  chunk_output_type: console
bibliography: bibliography.bib
spacing: double
header-includes:
  - \usepackage{subfig}
  - \usepackage{setspace}\doublespacing
  - \usepackage{amsmath}
  - \usepackage{amsthm}
  - \usepackage{placeins}
  - \newtheorem{prop}{\protect\propositionname}
  - \providecommand{\propositionname}{Proposition}
---

```{r setup, include = FALSE}

library(Formula)
library(car)
library(drake)
library(dplyr)
library(magrittr)
library(AER)
library(ggplot2)
library(Hmisc)
library(huxtable)
library(broom)
library(fixest)
library(santoku)
library(purrr)

knitr::opts_chunk$set(echo = FALSE)
options(huxtable.long_minus = TRUE)
theme_set(theme_minimal())

drake::loadd(mf_pairs)
drake::loadd(mf_pairs_twice)
drake::loadd(famhist)
drake::loadd(resid_scores)

famhist %<>% left_join(resid_scores, by = "f.eid")
rm(resid_scores)
famhist$EA3 <- famhist$EA3_excl_23andMe_UK_resid



```

\normalem

# Introduction

There is a well-known association between an individual's socio-economic status 
(SES) and their genetics. Twin studies show that the heritability of occupational
class and educational attainment, i.e. the proportion of variance explained by 
genetics, is around 50% [@Tambs_1989]. Genome-wide Complex Trait Analysis 
(GCTA) shows that even 2-year-old children's family SES can be predicted from their
genes [@Trzaskowski_2014]. Polygenic scores for educational attainment (EA) 
 predict both occupational class and (of course) EA itself [@Rimfeld_2018].

A common explanation is that in meritocratic societies, advantageous genes lead
to success in education and the labour market. Successful parents may then pass
both SES and their genes to their children, leading to an association between
the two [@belsky2018genetic]. This mechanism depends on the level of meritocracy
in society's institutions [@Heath_1985; @branigan2013variation]. Indeed, after
the fall of communism in Estonia, the heritability of SES increased, presumably
because post-communist society was more meritocratic [@Rimfeld_2018]. In a
non-meritocratic society where social status was ascribed rather than earned,
this mechanism could not take effect.

We propose an alternative explanation for the association between SES and genetics. 
It is centred on marriage markets rather than labour markets or educational 
institutions, and it relies on assortative mating, rather than meritocratic 
institutions. As a result, it applies to a historically wider range of 
societies. 

Our mechanism is that both social status[^ss-def] and genetics contribute to a
person's attractiveness in marriage markets. For example, suppose that wealth
and intelligence are both attractive qualities in a spouse. Then wealthy people
will be more likely to marry relatively intelligent people. Children of these
marriages will then inherit both wealth (via social institutions), and genetic
variants for intelligence (via biology). As a result, wealth and genes for
intelligence will become associated in the next generation. More generally,
whenever people in marriage markets trade social status for a genetically
inherited characteristic, the two will become associated.

[^ss-def]: *Social status* refers to characteristics that an individual has in
virtue of their social position. For example, my wealth is a fact about me that
holds in virtue of my relationship to certain social institutions (bank
deposits, title deeds etc.). Other examples include caste, class, income,
educational qualifications. *Socio-economic status* (SES) is a specific kind of
social status, existing in economically stratified societies, and referring to a
combination of educational attainment, occupational class, income and wealth
[e.g. @white1982relation].

We call this mechanism *Social-Genetic Assortative Mating* (SGAM). Note that it
does not require meritocracy. Even if social status is inherited from birth, and
cannot be earned (as with e.g. titles of nobility, or caste), it will still
become associated with attractive genetic variants, so long as there is
assortative mating and people trade status off for genetics in marriage markets.
By contrast, the ES mechanism, where social status can be earned with the help
of advantageous genetic variants, requires meritocracy but not assortative
mating. 

Another difference is in the chain of causality. In ES, genetic variants
cause an increase in social status, and both genetics and status may then be
inherited. In SGAM, causality may go from social status to genetics. One
person's social status causes their spouse to have different genetic variants;
again, both are then inherited. Thus, changes to social status may be encoded in 
the genetics of subsequent generations. 

The two mechanisms are complementary, and both
may operate in a given social setting. Table \@ref(tbl:conds) summarizes the
conditions for each mechanism.

| Mechanism | Genetics | Social status | Meritocracy | Assortative mating |
|:----------|:---------|:-------------|:-------------|:-------------------|
| ES | Inherited | Inherited | Yes | No |
| SGAM      | Inherited   | Inherited | No  | Yes|

Table: Conditions for Social-Genetic Assortative Mating (SGAM) and Earned Status (ES)  \label{tbl:conds}

Although SGAM does not require meritocracy, it is affected by a society's
marriage market institutions. Surprisingly, there is a non-linear relationship
between "egalitarianism" in marriage market institutions, and the strength of
the association between social status and genetic variation. When
marriage markets are fully egalitarian, or fully inegalitarian, SGAM does not
cause any association. In between these extremes, there is a positive
association. The intuition is that in a fully "egalitarian" marriage market,
social status plays no role in determining attractiveness. As a result, people
do not trade off social status against genetics. On the other hand, in a wholly
"inegalitarian" marriage market, such as a caste society where mating across
castes is forbidden, only social status determines attractiveness
and genetics plays no role, so again people do not trade the two off. In between
the two extremes, people trade social status for "good genes", and the two
become associated.

This paper tests for SGAM in a modern society. To pin down SGAM, we use a causal
antecedent of social status which is independent of individual genetics: birth
order. Birth order is known to affect outcomes including income, occupational
status and educational attainment. We show that people born earlier within a
sibling group marry spouses with different genetics, specifically, higher
polygenic scores for educational attainment. We present evidence that this
effect is mediated by measures of SES, including educational attainment and
labour market income. First, we develop a simple model of SGAM to show how
parents' social status predicts children's genetics, and how this varies with
social structure.


# Related literature

It is widely known that assortative mating may affect social inequality
[@greenwood2014marry], including variance in polygenic scores. But the mechanism
is usually genetic assortative mating (GAM), i.e. marriage partners having
similar genetic variants  [@hugh2016assortative]. A closely-related concept to
SGAM is cross-trait assortative mating [@Sundet_2005; @Beauchamp_2010]. This 
refers to people with (genes for) e.g. height marrying people with (genes for) 
e.g. intelligence. As a result, the two kinds of variation become associated. Our 
model simply extends this idea to the case of a socially-inherited trait and 
one or more genetic variants.

The basic idea behind SGAM is not new. It is a clichÃ© that e.g. wealth and
beauty tend to assort in marriage markets. However, few papers
has analysed this mechanism or drawn out its consequences explicitly.
@halsey1958genetics showed in a two-class model that social mobility combined
with assortative mating might increase the association between genetics and
social class. @belsky2018genetic offer three reasons for the association between
education-linked genetics and SES, but do not consider SGAM.


# Model

There is a large population, whose members have a single genetic trait
$g_{i}$ and a single social trait $s_{i}$, drawn from distributions $G$
and $S$. The genetic trait could be, for instance, a polygenic score,
which summarizes the effects of many alleles (genetic variants) at
different loci. The social trait is a measure of social status. Broadly
conceived, this means any trait that an individual possesses in virtue
of his or her position in society, rather than as a natural fact. Caste
and class are kinds of social status; so are wealth, income, education
and employment.

$G$ and $S$ are continuously distributed. Without loss of generality,
$EG = ES = 0$ and $Var(G) = Var(S) = 1$.[^3] People pair according to an
attractiveness function

[^3]: Continuous distribution is not strictly required. All that is
    needed is for a set of pairs of positive measure to have different
    values of $G$ and $S$, along a set of attractiveness curves of
    positive measure.

$$
A(g_{i},s_{i}) = f((1-k)g_{i},ks_{i})
$$

where $f$ is smooth and strictly increasing in both its arguments, and
$0 \le k \le 1$.

The key parameter is $k$. This describes the working of the society's
marriage market. If $k = 0$, only genetics $G$ are relevant in marriage
markets, and social status $S$ has no effect. That is, the marriage
market is highly egalitarian. Conversely, if $k = 1$, only social status
matters, to the complete exclusion of genetics. This is the equivalent
of a marriage market driven only by "caste" or "class". Realistic
societies are between these extremes.

Figure \@ref(fig:pic-intuition) shows the intuition behind our theory.
The top row shows a *caste marriage market* with $k = 1$. A typical pair
is shown: children have intermediate values of $G$ and $S$ between their
two parents (hollow circle). In this society pairs match only by social
status; genetics plays no role. As a result, while the variance of $G$
shrinks within each status group, genetics remain uncorrelated with
social status in the children's population distribution, shown on the
right. The next row shows a purely *egalitarian marriage market* with
$k = 0$. Parents match only by genetics and ignore social status. Again,
as a result there is no correlation between genetics and social status
in the children's generation. The bottom row shows a (more realistic)
intermediate society, with an intermediate value of $k$. Because both
genetics and social status contribute to attractiveness, matched spouses
typically trade them off against each other. As a result, the
distribution is squeezed along the gradient of $k$, and $G$ and $S$ are
correlated in the children's generation. We next prove this formally.

If $k = 0$, "indifference curves" of attractiveness are vertical lines
in $(G, S)$ space. If $k = 1$, they are horizontal lines. If
$k \in (0,1)$ they are downward sloping curves.

Write $p(i)$ for $i$'s partner. Pairs always have the same
attractiveness:

```{=tex}
\begin{equation}
A(g_{i},s_{i}) = A(g_{p(i)},s_{p(i)}),
\label{eq:same-A}
\end{equation}
```

Each pair has two children. We assume that both children $c(d)$ of
parents $d$, $m$ have

```{=tex}
\begin{align}
g_{c(d)} & =\frac{g_{d}+g_{m}}{2};\label{eq:children-average}\\
s_{c(d)} & =\frac{s_{d}+s_{m}}{2}.\nonumber 
\end{align}
```

This is a strong assumption; we relax it later. For real world examples
approximated by it, $S$ could be wealth which is equally divided between
the children; $G$ could be a highly polygenic trait with many small
effects. Write $G_{p}, S_{p}$ to denote the population variables in the
parents' generation; $G_{c}, S_{c}$ for the children's generation.

```{=tex}
\begin{prop}
\label{prop:prop1}
(i) $Cov(G_{c}, S_{c}) \ge Cov(G_{p},S_{p})$, with strict inequality
if and only if $0 < k < 1$. 

(ii) If $corr(G_{p}, S_{p}) \ge 0$, then $corr(G_{c},S_{c}) \ge corr(G_{p},S_{p})$,
with strict inequality if and only if $0 < k < 1$ \uline{or} 
$corr(G_{p}, S_{p}) > 0$.
\end{prop}
```

```{=tex}
\begin{proof}

Within each pair $i,p(i)$ write $d$ for the person with $s_{d}>s_{p(d)}$
and $m$ for $p(d)$. (Think of these as "dukes" and "milkmaids",
or if you prefer "duchesses" and "tennis instructors".) If
$k < 1$, then $g_{d} < g_{m}$. (If $k = 0$, then define $d$ as the person
with $g_{d} < g_{p(d)}$.)

We integrate over the "dukes" to calculate the covariance in the
parents' generation:
\[
cov(G_{p},S_{p})=\int\frac{1}{2}(g_{d}s_{d}+g_{p(d)}s_{p(d)})\,\mathrm{d}d.
\]

For the children, the equivalent expression is
\[
cov(G_{c},S_{c})=\int g_{c(d)}s_{c(d)}\mathrm{d}d,
\]

observing that $EG_{c} = ES_{c}=0$ from (\ref{eq:children-average}).

Take an arbitrary pair $d,m$. Write

\begin{align*}
g_{d}s_{d} & = (g_{c}-\Delta g)(s_{c}+\Delta s);\\
g_{m}s_{m} & = (g_{c}+\Delta g)(s_{c}-\Delta s)
\end{align*}

where 

\begin{align*}
\text{\ensuremath{\Delta g=\frac{g_{m}-g_{d}}{2}\ge0}}, & \textrm{strictly so if and only if }k>0;\\
\Delta s=\frac{s_{d}-s_{m}}{2}\ge0 & \textrm{strictly so if and only if }k<1.
\end{align*}

Taking the average of the parents gives

\[
\frac{1}{2}(g_{d}s_{d}+g_{m}s_{m})= g _{c}s_{c}-\Delta g\Delta s.
\]

This is less than $g_{c}s_{c}$ if $0 < k < 1$, and equal to it if $k = 0$
or $k = 1$. Plugging this into the integral shows that 

\[
cov(G_{p},S_{p})\le cov(G_{c},S_{c})
\]

again with strict inequality if and only if $0 < k < 1$. This proves the first
part. A similar argument, showing $var(G_c) \le var(G_p)$ and $var(S_c) \le
var(S_p)$, proves the second part (see the appendix). Figure
\ref{fig:Correlation-counterexample} in the appendix shows that the condition in
the second part cannot be relaxed further.

\end{proof}
```


```{r pic-intuition, fig.subcap = c("Caste society ($k = 1$): parents", "Caste society: children", "Egalitarian society ($k = 0$): parents", "Egalitarian society: children", "Intermediate society ($0 < k < 1$): parents", "Intermediate society: children"), fig.cap = "Theory: shaded area is the population distribution. Dotted lines are attractiveness isoquants. Solid dots are example parents, transparent dots are example children. The right hand side shows the children's generation.", fig.ncol = 2, fig.width = 2.75, fig.height = 2.4, fig.align='center'}


setup_plot <- function () {
  par(mar = rep(2.1, 4))
  plot.new()
  plot.window(c(-1.2, 1.2), c(-1.2, 1.2))
  arrows(x0 = -1.1, x1 = 1.1, y0 = -1.1, length = .1)
  arrows(y0 = -1.1, y1 = 1.1, x0 = -1.1, length = .1)
  text(-1.1, 1.2, "S", cex = 0.7)
  text(1.2, -1.1, "G", cex = 0.7)
}

draw_dist <- function (w) {
  if (! is.matrix(w)) w <- matrix(c(w, 0, 0, 1), nrow = 2)
  mygrey <- grey(.85, .03)
  for (rad in seq(0.2, 1, 0.1)) {
    v <- car::ellipse(c(0, 0), shape = w, radius = rad, add = TRUE, center.pch = NULL,
               fill = TRUE, col = mygrey, lwd = 0, segments = 241)
  }
  
  v
}

draw_dist_with_a <- function (width, shift, curved_lines = FALSE) {
  setup_plot()  
  v <- draw_dist(width)
  nr_v <- nrow(v)
  
  rotation <- (-shift + seq_len(nr_v)) %% nr_v
  rotation[rotation == 0] <- nr_v
  
  v <- v[rotation, ]
  v_rev <- v[nr_v:1, ]
  
  ivls <- quantile(seq_len(nr_v/2), seq(0.2, 0.8, .2), type = 1)
  
  start_x <- v[ivls, 1]
  end_x   <- v_rev[ivls, 1]
  start_y <- v[ivls, 2]
  end_y <- v_rev[ivls, 2]
  
  if (curved_lines) {
    for (l in seq_along(start_x)) {
      sx <- start_x[l] + c(0, 0.15, 0.85, 1) * (end_x[l] - start_x[l])
      sy <- start_y[l] + c(0, 0.05, 0.65, 1) * (end_y[l] - start_y[l])
      spl <- stats::spline(sx, sy)
      if (l ==2) mid_spl <- spl
      lines(spl, lty = 2)
    }
    
    start_x <- mid_spl$x[2]
    start_y <- mid_spl$y[2]
    end_x <- mid_spl$x[8]
    end_y <- mid_spl$y[8]
    inset <- 0
  } else {
    segments(x0 = start_x, x1 = end_x, y0 = start_y, y1 = end_y, lty = 2)  
    
    ivls <- ivls[2:3]
  
    start_x <- mean(v[ivls, 1])
    end_x   <- mean(v_rev[ivls, 1])
    start_y <- mean(v[ivls, 2])
    end_y   <- mean(v_rev[ivls, 2])
    inset <- 0.15
  }
  
  
  along <- function (tt) list(
    x = start_x + tt * (end_x - start_x),
    y = start_y + tt * (end_y - start_y)
  )
  
  end_inset <- 0.15
  starts <- along(c(inset, 1 - inset))
  ends   <- along(c(0.5 - end_inset, 0.5 + end_inset))
  pts <- along(c(inset/2, .5, 1 - inset/2))
  arrows(x0 = starts$x, x1 = ends$x, y0 = starts$y, y1 = ends$y,
         length = 0.05)
  
  points(x = pts$x, y = pts$y, pch = c(19, 21, 19), cex = 0.8)
}

draw_dist_with_a(.8, 0)
setup_plot()
invisible(draw_dist(matrix(c(.4, 0, 0, 1), nrow = 2)))

draw_dist_with_a(.8, 60)
setup_plot()
invisible(draw_dist(matrix(c(.8, 0, 0, .4), nrow = 2)))

draw_dist_with_a(.8, -30, curved_lines = TRUE)
setup_plot()
invisible(draw_dist(matrix(c(1, .4, .4, .8), nrow = 2)))



```

We view $k = 0$ and $k = 1$ as theoretical "ideal types". Proposition
\ref{prop:prop1} therefore shows that in almost any realistic society,
social status will become correlated with genetic traits which are
considered attractive in the marriage markets.

We now relax the condition that children are exactly at the mean of
their parents' values for $G$ and $S$. Let

```{=tex}
\begin{align*}
g_{c(i)} & = \bar{g}_{i}+\varepsilon_{i}^{G} \\
s_{c(i)} & = \bar{s}_{i}+\varepsilon_{i}^{S}
\end{align*}
```
where

$$
\bar{g}_{i} = \frac{g_{i} + g_{p(i)}}{2}; \bar{s}_{i} = \frac{s_{i} + s_{p(i)}}{2};
$$

$\varepsilon^{G}$ has mean 0 and variance $\sigma_{G}^{2}$; and
$\varepsilon^{S}$ has mean 0 and variance $\sigma_{S}^{2}$.


```{=tex}
\begin{prop}
\label{prop:robustness}

\begin{enumerate}

\item If $\sigma_{G}^{2}$ and $\sigma_{S}^{2}$ are small enough and $corr(G_{p},S_{p}) \ge 0$,
then $corr(G_{c},S_{c}) > corr(G_{p},S_{p})$ for $k \in (0,1)$.

\item If $\varepsilon^{G}$ and $\varepsilon^{S}$ are uncorrelated with
each other and with $\bar{G}$ and $\bar{S}$; and if $G_{p}$ and
$S_{p}$ are uncorrelated, then $corr(G_{c},S_{c}) \ge 0$, with strict
inequality if and only if $0<k<1$.

\end{enumerate}

\end{prop}
```


The conditions in Proposition \ref{prop:robustness} are quite plausible.
For $G$, they require that either variance in siblings' scores on some
summary statistic is not too large, or that it is uncorrelated with the
parents' scores. Both of these hold for most polygenic scores, which are
additive sums of many small effects of alleles derived randomly from one
or other parent. For $S$, the conditions would hold, for example, if $S$
measures wealth, which is inherited not too unequally between siblings;
or if wealth is inherited unequally but not in a way that correlates
with $S$ or $G$.

It is worth considering what kind of social arrangements would *violate*
these conditions. For example, suppose that parents' combined wealth is
inherited by the child with the lowest value of $g_{c(i)}$. This creates
a negative correlation between $s_{c(i)}$ and $g_{c(i)}$.

In the model, intermediate values of $k$ drive increased covariance
between genetics and social status. That naturally raises the question
whether the change in covariance and/or correlation is increasing in $k$
towards some maximum value in $(0,1)$, then decreasing, i.e., whether it
is quasiconcave in $k$. In general the answer is no, even on the
assumption that

$$
A(g_{i},s_{i}) = (1-k)g_{i} + ks_{i}
$$

i.e. that indifference curves are straight lines in $(G, S)$ space.
However, quasiconcavity in $k$ does hold when indifference curves are
straight and $(G, S)$ are jointly normally distributed. We conjecture
that it also holds whenever the distribution $(G, S)$ is log-concave or
even quasiconcave.


## Discussion

The "marriage market" here is a reduced form mechanism, encompassing
everything that makes a difference to partner choice. For example, if
earned income affects attractiveness in the marriage market, then
society's level of meritocracy in the labour market will correlate with
the value of $k$: a more meritocratic labour market will allow people
with low social status but high human capital (genetically
determined in part) to earn more, and therefore to match with more attractive
partners.

The contents of both $S$, social status, and $G$ -- "good
genes" in the marriage market -- are likely to vary across societies.
$S$ could encompass variables like social class or caste; ethnic
identity in "ranked" ethnic systems; or in modern societies, SES. 
Regarding $G$, standards of physical attractiveness, and other characteristics 
which make someone a "good match", vary both across societies and within a 
society over time.

The model predicts variation in the strength of SGAM. In
particular, in "caste societies" where there is complete endogamy within
social status groups, there is no scope for SGAM, because
marriage partners do not trade off genetics for social status. The model
also assumes that social status is inherited randomly from one parent,
in the same way a genetic allele is inherited. This assumption can be
weakened. For example, if social status is inherited deterministically
from the father, then the results remain unchanged (for each pair of
parents, just assume that one randomly chosen parent is the father).

In modern societies, both SGAM and ES are likely
to be at play. Genetic variants that cause (e.g.) higher income and
wealth will be inherited along with components of social status such as
inherited wealth. At the same time, higher social status and "good
genes" will assort in the marriage market, even if that higher social
status is caused by purely environmental variation. Our empirical
analysis shows this latter process at work.


# Data and methods

To test the theory, we use data from the UK Biobank, a study of about
500,000 individuals born between 1935 and 1970. The Biobank contains
information on respondents' genetics, derived from DNA microarrays,
along with questionnaire data on health and social outcomes. 

The Biobank does not contain explicit information on spouse pairs. We
categorize respondents as pairs if they:

* had the same home postcode on at least one occasion[^postcode]
* both reported living in the same type of accommodation,
  homeownership/renting status,  length of time at the address,
  number of inhabitants in the household, number of vehicles in the household,
  and number of children;
* both reported living with their spouse;
* consisted of one male and one female.

[^postcode]: Typically a UK postcode contains about 15 properties.

We also eliminated any pairs where either spouse appeared more than once in the
data. 

```{r validate-pairs}

drake::loadd(parent_child)
mf_w_parent <- mf_pairs %>% 
      left_join(parent_child, by = c("ID.m" = "parent_id")) %>% 
      left_join(parent_child, by = c("ID.f" = "parent_id"), 
                suffix = c(".m", ".f")) %>% 
      filter(! is.na(child_id.m) | ! is.na(child_id.f))


n_one_has_kid <- nrow(mf_w_parent)
n_both_same_kid <- mf_w_parent %>% 
                      filter(child_id.m == child_id.f) %>% # NAs excluded
                      nrow()


```

Some of these pairs could be false positives, i.e. people who are not
each others' spouse but simply live in the same postcode. To validate the
accuracy of our measures, we used genetic relationships. Some respondents
in the Biobank sample have a child who is also in the sample, as inferred from
genetic data. Out of our `r nrow(mf_pairs)` spouse pairs,
`r n_one_has_kid` have a genetic child of at least one partner in the sample. For `r n_both_same_kid` of these, the child is the genetic child of both 
partners. If this subsample is representative of the whole, then at least 
`r percent(n_both_same_kid/n_one_has_kid)` of the pairs who have had
a child, have had a child together. This is a lower bound because those who
had a child with someone else may also have had a child with the presumed partner
in our data.


Our key dependent variable is spouse's *Polygenic Score for Educational
Attainment* (PSEA). A polygenic score is a DNA-derived summary measure of
genetic risk or propensity for a particular outcome, created from summing small
effects of many common genetic variants, known as Single Nucleotide
Polymorphisms (SNPs). We focus on PSEA, rather than other polygenic scores,
because educational attainment plays a key role in human mate search. People are
attracted to educated potential partners [@buss1986preferences;
@belot2013dating]; spouse pairs often have similar levels of educational
attainment, as well as similar PSEA [@vandenberg1972assortative;
@schwartz2005trends; @greenwood2014marry;
@hugh2016assortative].  We use per-SNP summary statistics from [@lee2018gene],
recalculated excluding UK Biobank participants, to
calculate PSEA.[^residualized]

[^residualized]:  PSEA is residualized on the first 100 principal components of 
the SNP array data.

* TODO: if our N gets small, we may have to control, rather than residualize,
  to get accurate p-values.

Figures \@ref(fig:pic-basic-corr-uni) and \@ref(fig:pic-basic-corr-income)
illustrate the possible consequences of SGAM. The X axis shows a measure of one
partner's socio-economic status: university attendance (Figure
\@ref(fig:pic-basic-corr-uni) or income (Figure
\@ref(fig:pic-basic-corr-income)). The Y axis plots the other partner's mean
PSEA. Both males and females who went to university had spouses with higher
PSEA. So did males and females with higher income. Since DNA is inherited, these
people's children will also have higher PSEA.


```{r pic-basic-corr-uni, fig.subcap = c("Female PSEA by male educational attainment", "Male PSEA by female educational attainment"), fig.cap = "Social and genetic advantage among spouse pairs in UK Biobank", fig.width = 3, fig.height = 3}

pic_ss <- stat_summary(fun.data = mean_cl_normal, na.rm = TRUE)
pic_cc <- coord_cartesian(ylim = c(-0.2, 0.2))

mf_pairs %>% 
      filter(! is.na(university.m)) %>% 
      ggplot(aes(university.m, EA3.f)) + 
        pic_ss + 
        pic_cc +
        labs(x = "Male university attendance", y = "Female PSEA")

mf_pairs %>% 
      filter(! is.na(university.f)) %>% 
      ggplot(aes(university.f, EA3.m)) + 
        pic_ss + 
        pic_cc +
        labs(x = "Female university attendance", y = "Male PSEA")
        
```


```{r pic-basic-corr-income, fig.subcap = c("Female EA3 by male income", "Male EA3 by female income"), fig.cap = "Social and genetic advantage among spouse pairs in UK Biobank", fig.width = 3, fig.height = 3}

pic_ss <- stat_summary(fun.data = mean_se, fun.args = list(mult = 1.96))
pic_cc <- coord_cartesian(ylim = c(-0.15, 0.25))

mf_pairs %>% 
      filter(! is.na(first_job_pay.m)) %>% 
      mutate(Income = santoku::chop_deciles(first_job_pay.m, labels = 1:10)) %>% 
      ggplot(aes(Income, EA3.f)) + 
        pic_ss + 
        # pic_cc + 
        labs(x = "Male income decile", y = "Female PSEA")

mf_pairs %>% 
      filter(! is.na(first_job_pay.f)) %>% 
      mutate(Income = santoku::chop_deciles(first_job_pay.f, labels = 1:10)) %>% 
      ggplot(aes(Income, EA3.m)) + 
        pic_ss + 
        # pic_cc +
        labs(x = "Female income decile", y = "Male PSEA")
        
```


These figures do not prove that SGAM is taking place. Since an individual's own
PSEA correlates with both their educational attainment, and their income, both
figures could be a result of genetic assortative mating (GAM) alone
[@hugh2016assortative]. To demonstrate SGAM, we need a source of social status
which is exogenous to genetics. Also, the link between social status and spouse
genetics is likely to be noisy, for three reasons: first, polygenic scores
contain a large amount of error; second, causal mechanisms behind variation in
social status are likely to be noisy; third, to paraphrase
@shakespeare1595midsummer, the spouse matching process is notoriously
unpredictable. So, we need a large N to give us sufficient power. This rules out
time-limited shocks such as changes to the school leaving age [@Davies_2018].

We use *birth order*. It is known that earlier-born children receive more
parental care and have better life outcomes, including measures of SES such as
educational attainment and occupational status [@Lindahl_2008; @booth2009birth;
@black2011older]. On the other hand, all full siblings have the same *ex ante*
expected genetic endowment from their parents, irrespective of their birth
order. For example, siblings' expected polygenic score is equal to the mean of
their parents' polygenic scores. [^selection] We can therefore use birth order
as a "shock" to social status. We do not claim that birth order is exogenous to
all other variables. For example, it naturally correlates with parental age, and
it may also relate to the family's economic position at the time of birth. We
only claim that birth order is exogenous to genetic variation.

[^selection]: Although genetic variation is randomly assigned to children at
    birth, genetics and birth order could be dependent if parents'
    choice of whether to have more children is endogenous to the genetic
    endowment of their earlier children. We check for this below.

Our main independent variable is respondents' birth order, i.e. their
number of elder siblings plus one. For controls we use family size, i.e.
their total number of siblings including themselves; month of birth; age
at interview; respondents' own PSEA; their father's and/or mother's age
at their birth (calculated from parent's current age, only available if
the parent was still alive). To test whether birth order effects are
mediated by SES, we use two measures: income, and university attendance.
Current income is a direct measure of SES, while university attendance
is a predictor of income over the entire life course.

-   TODO: Abdel - details of PSEA calculation
-   TODO: look at mechanisms by which birth order might affect
    university
-   TODO: overall index of social status?

Ideally, we might prefer to use birth order as an instrument for SES.
However, our measures of social status are noisy and incomplete. For
example, we know whether subjects went to university, but not which
university they went to, and we only have rough categorical data on
household income. Birth order likely affects both these measures, and
other, unmeasured dimensions of SES. So, an instrumental variables
approach would probably fall foul of the exclusion restriction.

Instead, we conduct a mediation analysis, following the strategy of
[@heckman2013understanding]. We first confirm statistically that birth
order affects our measures of respondents' SES (income and education).
Then, we regress spouse's PSEA on birth order, with and without
controlling for SES. Under the assumption that birth order is exogenous
to own genetics, these regressions identify the effect of birth order,
plus other environmental variables that correlate with it, on own social
status and spouse's genetics. Also, if the estimated effect of birth
order on spouse's PSEA changes when SES is controlled for, that is
evidence that SES mediates the effect of birth order.

## Decomposition of the Birth Order effect on spouse genetics

Linearizing our model so that $A(g, s) = (1-k)g + ks$ and applying \@ref(eq:same-A) shows that:

```{=tex}
\[
\frac{d A(g_{p(i)}, s_{p(i)})}{d s_i} = k
\]
```

We wish to test whether $k \in (0, 1)$, i.e. whether GSAM is taking place.
If $k > 0$ then an increase in $i$'s social status $s_i$ will increase $i$'s attractiveness $A$; if $k < 1$ then an increase in $A$ will be associated (in expectation) with 
an increase in $i$'s partner's genetic endowment $g_{p(i)}$. We therefore wish to  estimate the effect of $i$'s status on their partner's genetics,
while controlling for $i$'s own genetics $g_i$. Since our measures of genetic
endowment (e.g. PSEA) are noisy and incomplete, it is not enough to include them in 
the regression. Instead, we use birth order as a source of variation in $s_i$
which is orthogonal to $g_i$.

We follow @heckman2013understanding to
decompose the aggregate treatment effect into components due to observed and
unobserved proximate channels affected by the treatment. Our aim is to
estimate the effect of SES (as an effect of birth order) on spouse PSEA.

The reduced-form regression of spouse PSEA on birth order ($BO$) is:

```{=tex}
\begin{align}
Y  = \delta +\alpha \cdot BO+\beta \cdot \textbf{X} + \varepsilon,
\end{align}
```

where $Y \equiv g_{p(i)}$ and $\textbf{X}$ is a vector of predetermined controls
(own year of birth, own PSEA, father or mother's year of birth).

Assume $BO$ is a binary treatment variable (e.g. indicator for first
born). Then, the observed outcome is:

```{=tex}
\begin{align}
Y = BO \cdot Y_1 + (1-BO) \cdot Y_0  \label{eq:Y-BO}
\end{align}
```

$Y_d$ with $d\in${0,1} are the counterfactual outcomes for the first and
second born, respectively. Given $d$, spouse PSEA is assumed to be
independent across observations, conditional on predetermined controls,
which are assumed not to be affected by $BO$.

Let $\theta_d$ be a set of proximate outcomes determined by $BO$, which
account (at least in part) for the $BO$ treatment on spouse PSEA. We can
think of $\theta_d$ as all the channels by which $BO$ affects
attractiveness in the marriage market, including socio-economic status
(SES), health, cognitive and non-cognitive skills. Similar to
(\ref{eq:Y-BO}) we define
$\theta = BO\cdot theta_1 + (1-BO)\cdot\theta_0$. We are mainly
interested in estimating the effect of SES on spouse PSEA.

Our linear model is:

```{=tex}
\begin{align}
Y_d = \kappa_d +\alpha_d \cdot \theta_d+\beta_d \cdot  \textbf{X}+\tilde{\varepsilon_d},  \label{eq:linear-model}
\end{align}
```

We can simplify the model if we assume that the effects of $\textbf{X}$
do not differ by treatment, i.e. $\beta_0=\beta_1$.
$\tilde{\varepsilon_d}$ is a mean-zero residual assumed independent of
$\theta_d$ and $\textbf{X}$.

We can break down the set of investments $\theta_d$ into SES and other
measured investments, and investments or skills we cannot measure.


-   TODO: bold the alpha and theta and beta vectors in eq 3.

```{=tex}
\begin{equation}
Y_d=\tau_d +\sum_{j\in J_m} \alpha_d^j \cdot \theta_d^j + \beta \cdot \textbf{X}+\varepsilon_d,  \label{eq:measured-unmeasured}
\end{equation}
```

where $\tau_d=\kappa_d+\sum_{j\in J_u} \alpha_d^j \cdot E(\theta_d^j)$ and
$\varepsilon_d=\tilde{\varepsilon_d}+\sum_{j\in J_u} \alpha_d^j \cdot (\theta_d^j-E(\theta_d^j))$ and $J_m$ and $J_u$ are the index sets of mediators
of $BO$ which are measured and unmeasured.

We assume differences in unmeasured investments due to $BO$ are
independent of $\textbf{X}$. We also assume that $\alpha_0 = \alpha_1$ (we
can test this if the measured and unmeasured investments gains from BO
are independent in both treatment regimes).

With these assumptions, substituting equation
(\ref{eq:measured-unmeasured}) into (\ref{eq:Y-BO}) we obtain:

```{=tex}
\begin{equation}
Y=\tau_0 +\tau \cdot BO+ \sum_{j\in J_m} \alpha^j \cdot \theta^j + \beta \cdot \textbf{X}+\varepsilon,  \label{eq:Y-BO-decomposed}
\end{equation}
```
Where $\tau=\tau_1-\tau_0$ is the contribution of unmeasured variables
to average treatment effects,
$\varepsilon = BO \cdot \varepsilon_1 + (1-BO)\cdot \varepsilon_0$ is a
zero-mean error term, and
$\theta^j = BO \cdot \theta_1^j + (1-BO)\cdot \theta_0^j$ , $j\in J_m$
denote the investments that we can measure.

Estimating (\ref{eq:Y-BO-decomposed}) by OLS will generate unbiased
estimates of $\alpha^j$, $j\in J_m$ if $\theta^j$ is measured without
error and is uncorrelated with the error term $\varepsilon$. Since
$\varepsilon$ contains both individual disturbances
$\tilde{\varepsilon}$ and differences in unmeasured investments due to
BO, the identifying assumptions that need to hold for unbiased OLS
estimates are:

1.  The measured investments (specifically SES) should be independent of
    unmeasured investments generated by BO. Failing this, the estimates
    $\alpha^j$ will be conflated with the effects of unmeasured
    investments.

2.  The measured investments should be uncorrelated with other shocks
    $\tilde{\varepsilon}$.

The overall treatment effect can then be decomposed as follows:

```{=tex}
\begin{equation}
E(Y_1-Y_0)=\tau_1-\tau_0 + \sum_{j\in J_m} \alpha^j \cdot E(\theta_1^j-\theta_0^j),  \tag{6}
\end{equation}
```

Where $\tau_1 - \tau_0$ is the unmeasured component of the treatment
effect and $\sum_{j\in J_m} \alpha^j \cdot E(\theta_1^j-\theta_0^j)$ is
the treatment effect due to measured investments.

By running a least square regression of (\ref{eq:Y-BO-decomposed}), we
can estimate $\tau_1-\tau_0$. If assumption 1. above
holds, the part of the BO treatment effect on spouse PSEA due to
measured investments can be constructed using the estimated $\alpha^j$
and the effects of treatment on measured investments (from an OLS
regression of measured variables on the BO treatment).

-   TODO:clarify how this ports to the case of discrete treatment with
    multiple values. OR do regressions with first born vs later born (as
    first-born is anyway the most different in terms of university and
    income)
-   TODO:We need to discuss the plausibility of these assumptions and
    what we can do to test it.

# Results

```{r calc-bo-first-stage}

mod_bo_1st <- list()
mod_bo_1st$uni    <- lm(university ~ birth_order + factor(n_sibs), famhist, 
                    subset = n_sibs >= 2 & n_sibs <= 8)
mod_bo_1st$income <- lm(first_job_pay ~ birth_order + factor(n_sibs), famhist, 
                    subset = n_sibs >= 2 & n_sibs <= 8)

pval_bo_1st <- map(mod_bo_1st, 
                 ~tidy(.x) %>% filter(term == "birth_order") %>% pull(p.value)
               )
pval_bo_1st %<>% map(format, digits = 3)
```

Figures \@ref(fig:pic-bo-uni) and \@ref(fig:pic-bo-income) show the
relationship between birth order, university education and income,
separately for respondents with 1-3 siblings. We test this formally in a
linear regression, controlling for family size, which may be correlated
with parental characteristics including genetics. Birth order is
negatively associated with both university attendance and income (among
respondents with 1-7 siblings: university $p$ = `r pval_bo_1st$uni`,
income $p$ = `r pval_bo_1st$income`).

```{r pic-bo-uni, fig.cap = "University attendance by birth order and family size", fig.height = 3}

famhist %>% 
      filter(n_sibs <= 4, n_sibs >= 2, ! is.na(birth_order)) %>% 
      mutate(
        `Birth order` = birth_order,
        `Family size` = n_sibs
      ) %>% 
      group_by(`Birth order`, `Family size`) %>% 
      dplyr::summarize(University = mean(university, na.rm = TRUE), 
                       .groups = "drop_last") %>% 
      ggplot(aes(`Birth order`, University)) + 
        geom_col() +
        facet_grid(cols = vars(`Family size`), labeller = label_both) 

```

```{r pic-bo-income, fig.cap = "Median income of first job by birth order and family size", fig.height = 3}

famhist %>% 
      filter(
        n_sibs <= 4, 
        n_sibs >= 2, 
        ! is.na(birth_order), 
        ! is.na(first_job_pay)
      ) %>% 
      mutate(
        `Birth order` = factor(birth_order),
        `Family size` = n_sibs,
        `Income` = first_job_pay
      ) %>% 
      ggplot(aes(`Birth order`, Income)) + 
      stat_summary(fun.data = mean_se, fun.args = list(mult = 1.96)) +
      facet_grid(cols = vars(`Family size`), labeller = label_both)
```

Next we run regressions of spouse PSEA on birth order. Table
\@ref(tab:tbl-bo-psea-basic) reports the results. Subjects with 1-7
siblings are included. Column 1 controls only for family size (using
dummies). As expected, higher birth order is negatively associated with
spouse's PSEA, though the estimated effect size is small. Column 2
includes the respondent's own PSEA, as well as dummies for birth year to
control for cohort effects, and dummies for birth month to control for
seasonality effects. The effect size of birth order is not much changed.

Column 3 includes father's age at birth. Within a family, later children
have older parents by definition. Older parents have more life
experience and may have higher income, which would presumably help later
children. On the other hand, an early explanation for birth order
effects was that these could be due to genetic mutations in older
fathers, although more recent research has rejected this in favour of
"social" explanations [@kristensen2007explaining; @black2011older].[^5]
Including father's age means we can separate the effect of father's age
from birth order. This reduces the N by a lot, since only respondents
with live fathers reported the necessary data. However, the effect of
birth order jumps in size, to about half the effect of respondent's own
PSEA. Meanwhile, father's age has a positive effect. This suggests that
the previous estimates mixed two opposite-signed effects: having older
parents versus being later in birth order.[^6]

[^5]: [@cochran2013paternal] report that mutational load is
    approximately linear in father's age, while it is constant in
    mothers' age. We observe very similar results if we control for
    mother's age at respondent's birth.

[^6]: Note that parental age would not be a good independent variable
    for testing genetic encoding of social advantage, since it is likely
    to correlate with parents' genetics.

```{r tbl-bo-psea-basic}

fml_bo_psea_base <- list()

fml_bo_psea_base[[1]] <- EA3.y ~ birth_order.x | factor(n_sibs.x)
fml_bo_psea_base[[2]] <- EA3.y ~ birth_order.x + EA3.x + factor(birth_mon.x) |
                            factor(n_sibs.x) + factor(YOB.x)
  
fml_bo_psea_base[[3]] <- EA3.y ~ birth_order.x + EA3.x + factor(birth_mon.x) +
                            fath_age_birth.x | factor(n_sibs.x) + factor(YOB.x)

fml_bo_psea_base <- lapply(fml_bo_psea_base, Formula::as.Formula)

mf_pairs_reg <- mf_pairs_twice %>% 
                  filter(
                    n_sibs.x >= 2, 
                    n_sibs.x <= 8, 
                    ! is.na(birth_order.x)
                  )

mod_bo_psea_base <- lapply(fml_bo_psea_base, fixest::feols, 
                 data = mf_pairs_reg,
                 notes = FALSE
               )

huxreg(mod_bo_psea_base, 
        coefs = c(
          "Birth order"           = "birth_order.x", 
          "Own PSEA"               = "EA3.x",
          "Father's age at birth" = "fath_age_birth.x"
        ),
         statistics = c(
           "N"           = "nobs", 
           "R2"          = "r.squared"
          ),
         note = "{stars}. Standard errors clustered by spouse pair. Respondents with 1-7 siblings included.",
         tidy_args = list(conf.int = FALSE, cluster = list(mf_pairs_reg$couple_id))
       ) %>% 
       insert_row(after = 7, "Family size dummies", rep("Yes", 3)) %>% 
       insert_row(after = 8, "Birth month dummies", "No", "Yes", "Yes") %>% 
       insert_row(after = 9, "Birth year dummies", "No", "Yes", "Yes") %>% 
       set_bottom_border(8:9, everywhere, 0) %>% 
       set_number_format(2:7, -1, 4) %>% 
       set_width(0.8) %>% 
       set_caption("Regressions of spouse PSEA on birth order")


```

-   TODO: maybe - include age FTE as well as university - to check university
    has an "extra effect" - this slightly suggests that uni is a
    "marriage market" and not just granting extra skills

-   TODO: maybe - consider alternative exogenous shocks to income. For example,
    some professions are more "cyclical" than others wrt recessions. If
    we could do predicted income at age 21-25 from business cycle X
    profession, that might count as exogenous. (Could use an independent
    source to estimate evolution of incomes, e.g. GHS or BHPS)
    
- TODO: number of elder *brothers*? (We don't have this info but we have
  total number of brothers, so we can interact this with the birth order effect)

Having tested that birth order affects spouse's PSEA, we now look for
potential mediators of this effect. Despite the lower N, we continue to
control for respondents' fathers' age, since this removes a confound
which would bias our results towards zero.[^7]

[^7]: The appendix reports results without controlling for father's age.

```{r tbl-bo-psea}


fml_bo_psea <- list()

fml_bo_psea[[1]] <- EA3.y ~ birth_order.x | factor(n_sibs.x)
fml_bo_psea[[2]] <- EA3.y ~ birth_order.x | factor(n_sibs.x)
fml_bo_psea[[3]] <- EA3.y ~ university.x + birth_order.x | factor(n_sibs.x)
fml_bo_psea[[4]] <- EA3.y ~ first_job_pay.x + birth_order.x | factor(n_sibs.x)
fml_bo_psea[[5]] <- EA3.y ~ first_job_pay.x + university.x + birth_order.x |
      factor(n_sibs.x)

fml_bo_psea <- lapply(fml_bo_psea, Formula::as.Formula)

# common controls
fml_bo_psea <- lapply(fml_bo_psea, update, 
                        . ~ . + EA3.x + fath_age_birth.x,
                        rhs = 1)
fml_bo_psea <- lapply(fml_bo_psea, update, 
                        . ~ . + factor(YOB.x) + factor(birth_mon.x),
                        rhs = 2)

# alternative mediators
fml_bo_psea[-1] <- lapply(fml_bo_psea[-1], update,
                            . ~ . + sr_health.x + fluid_iq.x, 
                            rhs = 1)


mf_pairs_reg <- mf_pairs_twice %>% 
                  filter(
                    n_sibs.x >= 2, 
                    n_sibs.x <= 8, 
                    ! is.na(birth_order.x),
                    ! is.na(university.x),
                    ! is.na(first_job_pay.x),
                    ! is.na(fath_age_birth.x)
                  )

mod_bo_psea <- lapply(fml_bo_psea, fixest::feols, 
                 data = mf_pairs_reg,
                 notes = FALSE
               )

huxreg(mod_bo_psea, 
        coefs = c(
          "Birth order"           = "birth_order.x", 
          "University"            = "university.xTRUE", 
          "Income"                = "first_job_pay.x",
          "Father's age at birth" = "fath_age_birth.x",
          "Own PSEA"              = "EA3.x",
          "Fluid IQ"              = "fluid_iq.x",
          "Self-rated health"     = "sr_health.x"
        ),
         note = "{stars}. Standard errors clustered by spouse pair.",
         tidy_args = list(conf.int = FALSE, cluster = list(mf_pairs_reg$couple_id))
       ) %>% 
       insert_row(after = 15, "Family size dummies", rep("Yes", 5)) %>% 
       insert_row(after = 16, "Birth month dummies", rep("Yes", 5)) %>% 
       insert_row(after = 17, "Birth year dummies", rep("Yes", 5)) %>% 
       set_bottom_border(16:17, everywhere, 0) %>% 
       set_number_format(2:15, -1, 4) %>% 
       set_caption("Regressions of spouse PSEA on birth order and potential mediators")
```

```{r calc-bootstrap-proportions, cache = TRUE, eval = FALSE}

# to rerun this, just add a space below. Don't set cache = FALSE!
n_boot <- 199 

bo_prop_boot <- replicate(n_boot, {
  mf_pairs_resample <- mf_pairs_reg %>% sample_frac(1, replace = TRUE)
  tmp  <- fixest::feols(fml_bo_psea[[2]], data = mf_pairs_resample, notes = FALSE)
  tmp2 <- fixest::feols(fml_bo_psea[[3]], data = mf_pairs_resample, notes = FALSE)
  tmp3 <- fixest::feols(fml_bo_psea[[4]], data = mf_pairs_resample, notes = FALSE)
  tmp4 <- fixest::feols(fml_bo_psea[[5]], data = mf_pairs_resample, notes = FALSE)
  orig_coef <- coef(tmp)["birth_order.x"]
  c(
    prop_uni  = coef(tmp2)["birth_order.x"]/orig_coef,
    prop_inc  = coef(tmp3)["birth_order.x"]/orig_coef,
    prop_both = coef(tmp4)["birth_order.x"]/orig_coef
  )
})
```

```{r clean-bootstrap-proportions, eval = FALSE}
bo_prop_ci <- apply(bo_prop_boot, 1, quantile, probs = c(.975, .025))
# the percentage reduction:
bo_prop_ci[] <- sprintf("%.1f%%", (1 - bo_prop_ci) * 100)

# point estimates from main regressions:
orig_coef <- coef(mod_bo_psea[[1]])["birth_order.x"]
bo_prop_est <- apply(bo_prop_boot, 1, mean)
bo_prop_est  <- sprintf("%.1f%%", (1 - bo_prop_est) * 100)

```


Table \@ref(tab:tbl-bo-psea) shows the results. Column 1 shows the effect of
birth order, using the same specification as column 3 of the previous table. (We
exclude respondents without data on income or university attendance, to make
comparison easier across the columns: this reduces the N.) The remaining columns
add potential mediators of birth order effects. Column 2 includes fluid IQ and
self-rated health, both of which could be affected by birth order and affect
spouse matching. Columns 3 to 5 then add our measures of SES. Column 3 includes
university attendance. Column 4 includes income. Column 5 includes both.

Controlling for fluid IQ and self-rated health (column 2) does not reduce the
effect of birth order, although both variables are significant in the expected
direction. When we add a control for university attendance (column 3), the
effect of birth order drops and becomes insignificant. The fluid IQ variable
also loses size and significance, suggesting that this effect too may work via
itse effect on university attendance. By contrast, self-rated health is
unaffected. Controlling for income alone (column 4), birth order again becomes
insignificant though its size is unchanged. Lastly, when we control for both
university and income, again birth order's effect size drops and the coefficient
becomes insignificant.

```{r, eval = FALSE}
- TODO: not sure if we need do this. It's slow. Oana to comment.

# We estimate the percentage decrease in the effect of
# birth order across the columns, along with 95% confidence intervals for
# this figure, by running bootstraps (N = `r n_boot`).[^8] Including
# university attendance alone reduces the effect of birth order by
# `r bo_prop_est[1]` (CI `r bo_prop_ci[1, 1]` -- `r bo_prop_ci[2, 1]`).
# Including income alone reduces the effect of birth order by
# `r bo_prop_est[2]` (CI `r bo_prop_ci[1, 2]` -- `r bo_prop_ci[2, 2]`).
# Including both decreases the effect by `r bo_prop_est[3]` (CI
# `r bo_prop_ci[1, 3]` -- `r bo_prop_ci[2, 3]`).
# 
# [^8]: The sample percentage decrease calculated from the figures in
#     Table \@ref(tab:tbl-bo-psea) is not the correct estimator, since
#     $E(X/Y)$ is not equal to $EX/EY$.
```

Our next regressions split up the data into subsets. Cultural
stereotypes often assume that the link between status and genes is not
symmetric across the genders, for example, that males with high SES are
particularly likely to marry attractive spouses. To test this, we
separately regress male spouses' PSEA on female birth order, and female
spouses' PSEA on female birth order. We also rerun regressions among the
subset of individuals who had children. A significant result here will
confirm that the association between status and genetics is carried over
into the next generation.

Table \@ref(tab:tbl-bo-subsets) shows the results. Columns 1 and 2 use birth
order of male respondents to predict female spouses' PSEA. Column 1 runs the
regression of birth order plus controls; column 2 adds the full set of
mediators, including university and income. Columns 3 and 4 repeat the exercise
for female respondents, using their birth order to predict male spouses' PSEA.
Effect sizes are larger for female respondents. This might be because social
status matters more for females in the marriage markets (contrary to a common
stereotype), or because males place less value on phenotypes related to PSEA.
Columns 5 and 6 use only couples with children. The effect of birth order is
larger than for the sample as a whole, and university attendance and income
still seem to mediate the birth order effect.

-   TODO: very few couple pairs (\< 50%) report the same number of
    children. Why?

    -   equally likely to be males or females reporting more.

```{r tbl-bo-subsets}

# TODO: is 1 vs 5 the right comparison? 1 has no "mediating" controls, 5
# has a full set

mod_bo_males <- lapply(fml_bo_psea[c(1, 5)], fixest::feols, 
                 data = mf_pairs_reg %>% filter(x == "Male"),
                 notes = FALSE
               )
mod_bo_females <- lapply(fml_bo_psea[c(1, 5)], fixest::feols, 
                 data = mf_pairs_reg %>% filter(x == "Female"),
                 notes = FALSE
               )

mf_pairs_children <- mf_pairs_reg %>% 
                   filter(n_children.x > 0, n_children.y > 0)
mod_bo_children <- lapply(fml_bo_psea[c(1, 5)], fixest::feols, 
                 data = mf_pairs_children,
                 notes = FALSE
               )

ta <-  list(conf.int = FALSE, cluster = list(mf_pairs_children$couple_id))

reg_list <- list(
        "Male respondents"     = mod_bo_males[[1]],
        "Male respondents"     = mod_bo_males[[2]],
        "Female respondents"   = mod_bo_females[[1]],
        "Female respondents"   = mod_bo_females[[2]],
        "With children"        = mod_bo_children[[1]],
        "With children"        = mod_bo_children[[2]]
      )

huxreg(reg_list,
       coefs = c(
          "Birth order"           = "birth_order.x", 
          "University"            = "university.xTRUE",
          "Income"                = "first_job_pay.x",
          "Father's age at birth" = "fath_age_birth.x",
          "Own PSEA"              = "EA3.x",
          "Fluid IQ"              = "fluid_iq.x",
          "Self-rated health"     = "sr_health.x"
        ),
       statistics = c("N" = "nobs", "R2" = "r.squared"),
         note = "{stars}. Standard errors for columns 5 and 6 clustered by spouse pair.",
          tidy_args = list(list(), list(), list(), list(), ta, ta)
       ) %>% 
       insert_row(after = 15, "Family size dummies", rep("Yes", 6)) %>% 
       insert_row(after = 16, "Birth month dummies", rep("Yes", 6)) %>% 
       insert_row(after = 17, "Birth year dummies", rep("Yes", 6)) %>% 
       set_bottom_border(16:17, everywhere, 0) %>% 
       set_font_size(10) %>% 
       set_width(1) %>% 
       set_caption("Regressions of spouse PSEA on birth order: subsets")
```

\FloatBarrier

## Robustness

Although all children of the same parents have the same polygenic scores
in expectation, it could still be possible that genetics correlates with
birth order within the sample. This could happen in three ways.

First, siblings with high birth order will typically come from larger
families than those with low birth order, and parents of different-sized
families are likely to differ systematically on many dimensions,
including genetics. We controlled for this by including a full set of
family size dummies in the regression.[^9]

[^9]: Table \@ref(tab:tbl-bo-psea-interactions) in the appendix
    estimates a separate birth order coefficient within each family
    size.

Second, there could be ascertainment bias. For example, if later
siblings with high PSEA, and earlier siblings with low PSEA, are more
likely to enter the sample, then this would bias our results.

Thirdly, parents might select family size on the basis of genetics. For
example, suppose that if the first child had a phenotype reflecting a
high PSEA, parents are more likely to have a second child. Then within
the subset of two-child families, first children would have
higher-than-average PSEA while second children would not.


```{r tbl-pgs-check, cache = TRUE}

# TODO: rerun this once we've sorted out mf_pairs properly

check_cor <- function (score_name) {
  fml_check <- as.formula(paste(score_name, "~ factor(n_sibs) + birth_order"))
  mod_check <- lm(fml_check, famhist, n_sibs >= 2 & n_sibs <= 8 & ! is.na(birth_order))
  mod_check %>% 
        tidy() %>% 
        filter(term == "birth_order") %>% 
        mutate(score = score_name)
}

check_cor_within <- function (score_name) {
  fml_check_within <- as.formula(paste(score_name, 
                        "~ 0 + factor(n_sibs) + factor(n_sibs):factor(birth_order)"))
  mod_check <- lm(fml_check_within, famhist, 
                  n_sibs >= 2 & n_sibs <= 8 & ! is.na(birth_order))
  # NB: the model creates NA estimates for when n_sibs <= birth_order
  # since these have 0 rows in the data. I think this is not a problem.
  mod_check %>% 
        tidy() %>% 
        filter(grepl("birth_order", term)) %>% 
        filter(! is.na(estimate)) %>% 
        mutate(score = score_name)
}

drake::loadd(score_names)
score_names <- paste0(score_names, "_resid")
balance_check <- purrr::map_dfr(score_names, check_cor)
balance_check_within <- purrr::map_dfr(score_names, check_cor_within)

if (any(balance_check$p.value < 0.1/33)) stop("Some check p values < 0.1/33; rewrite text!")

n_10 <- sum(balance_check$p.value < 0.1)
# if (n_10 != 3) stop("Different number of PGS had p < 0.10; rewrite text!")

n_within_coefs <- nrow(balance_check_within)
if (any(balance_check_within$p.value < 0.001)) stop("Some within-siblings p values < 0.001; rewrite text!")


max_coef <- max(abs(balance_check$estimate))
```


To check for these two problems, we run balance tests on 33 different polygenic
scores.[^10] We regress each score on birth order, controlling for
family size. No scores were significant at $p < 0.10/33$. `r n_10`
scores were significant at $p < 0.10$ (body mass index,
conscientousness, and neuroticism). Coefficients were never greater than
0.01 of a standard deviation. Table \@ref(tab:tbl-bo-psea-robust) in the
appendix reruns regressions controlling for these scores. Results are
almost unchanged. To test whether polygenic scores might vary for
particular birth orders within particular family size, we also regress
each score on a full set of birth order dummies, interacted with a full
set of family size dummies. None of the `r n_within_coefs` birth order
coefficients were significant at $p < 0.001$. Of course, there could
still be unmeasured genetic variants which correlate with birth order in
our sample. Nevertheless, a wide set of polygenic scores shows no large
or significant correlation. This increases our confidence that birth
order is indeed exogenous to genetics.

[^10]: Polygenic scores were residualized on the first 100 principal
    components of the genetic data. Scores were for: ADHD, age at
    menarche, age at menopause, agreeableness, age at smoking
    initiation, alcohol use, Alzheimer's, autism, bipolarity, BMI, body
    fat, caffeine consumption, cannabis (ever vs. never), cognitive
    ability, conscientiousness, coronary artery disease, smoking
    (cigarettes per day), type II diabetes, drinks per week, educational
    attainment (EA2 and EA3), anorexia, extraversion, height, hip
    circumference, major depressive disorder, neuroticism, openness,
    smoking cessation, schizophrenia, smoking initiation, waist
    circumference, and waist-to-hip ratio.

# Conclusion


Behaviour geneticists have pointed out that in meritocratic societies,
genetics and social status will be correlated, because some genetic
variants will lead to success in the labour market. We argue that
causality can also go the other way. If social status and genetics both
matter in marriage markets, then people with high social status will
attract partners with "good genes", and the two will become associated
in the next generation.

Our empirical analysis shows that in a modern Western democracy,
earlier-born children had spouses with higher PSEA. Thus, an
environmental shock has effects on the genetics of people's spouses and
becomes encoded in the genetics of their children. We also provided
evidence that these effects are mediated by social status: income and
education.

It has been widely believed in many societies that innate
traits do vary across social classes. The ancient Greeks described the
social elite as *kaloi kagathoi* ("fine and good"), while the Roman
nobility were the *optimates* ("best").[^11] This belief has been
explained by the human tendency to believe in a just world
[@furnham1993just], or as an ideology promoted by the dominant class
[e.g. @gramsci1971selections]. However, it may also simply have been a
recognition of (social) reality. In other words,
the belief that elites are taller, stronger, better-looking, etc. is not
much different from the belief that elites are richer and more powerful,
and is likely to be held for fairly similar reasons.

[^11]: The appendix contains a selection of relevant historical
    quotations.

In our model, the association between social status and genetic
variation depends on the structure of the society's marriage market. The
association is weaker when marriage markets are very socially
egalitarian, with marriage pairing driven only by genetics, or very
inegalitarian, with pairings driven only by status. This logic is
different from the standard reason for association between genes and
SES. There, more meritocratic societies allow a greater role for genetic
variants linked to labour market success, and thus lead to monotonically 
stronger gene-environment correlations (rGE) with SES. Here, the relationship is
non-monotonic: rGE is strongest at intermediate levels of "meritocracy"
in marriage markets. Comparing rGE across societies or over time is
beyond our scope here, but we see it as a good area for future work.
Marriage markets may play an important role in explaining how social
inequality varies across different societies.

Over history, SGAM has probably operated in a
much greater variety of societies than earned status,
because societies in which status can be earned are relatively rare
compared to those in which status is inherited. (TODO: cite WEIRD? Or
"status vs contract"?) As a result, we would predict long-standing
correlations between social status and causal genetic variants. This
prediction could be tested on ancient DNA data.

Our analysis also has implications for the practice of controlling
polygenic scores by residualizing on principal components of genetic
data. This is done so as to avoid confounding the effects of genetic
variation with social stratification. However, insofar as the
geneticists' concept of stratification (mating which is non-random with
respect to genetics) overlaps with the sociological concept of
stratification (a hierarchical ranking of social status), SGAM predicts
that stratification will be associated with causally relevant genetic variants. For
this reason, we would expect principal components to contain real
information about causally relevant variants. So, it is an empirical
question whether controlling for principal components improves or
weakens the predictive power of polygenic scores. Within-family analyses
could resolve this question.

The broadest message of this paper is that *genetics are a social outcome*.
Both popular and scientific discourse often
parse genetics as "nature", in opposition to "nurture" or "society" [e.g.
@plomin1994genetics; @chakravarti2003nature]. This idea expresses the fact that our
genetic endowment is fixed at birth and cannot be influenced by our
social environment (though genes may interact with the environment to cause
different outcomes). But the idea that human
genetics are natural can be highly misleading. Humans inherit their
genes from their parents, along with other forms of inheritance such as
economic and cultural capital. Human parents, in turn, form spouse
pairs, bear children, and raise them, within social institutions. A person's
genetic inheritance is a social and historical fact about them, and not
a fact of nature, any more than their inherited wealth or social status
is natural. As [@marx1844economic] wrote, "History is the true natural
history of man".[^marx] Genetic endowments can even be viewed as another form
of capital, alongside human, social and cultural capital: a resource to
be sought, accumulated and competed over. The analysis of this kind of
capital is an exciting area for further research, which will require the
contributions of both social scientists and geneticists.

[^marx]: He also wrote (ibid.) "I am ugly, but I can buy the most beautiful woman.... 
the effect of ugliness, its repelling power, is destroyed by money".

\FloatBarrier

\newpage

# Appendix

## Second part of Proposition \@ref(prop:prop1)

```{=tex}
\begin{proof}
Write

\begin{equation}
corr(G_{j},S_{j})=\frac{cov(G_{j},S_{j})}{\sqrt{var(G_{j})var(S_{j})}}\textrm{ for both generations }j\in\{p,c\}.\label{eq:corr-cov-var}
\end{equation}

where 

\begin{align*}
var(G_{p}) & =\frac{1}{2}\int g_{d}^{2}+g_{p(d)}^{2}\textrm{d}d;\\
var(G_{c}) & =\int g_{c(d)}^{2}\textrm{d}d.
\end{align*}

Much as before,
\begin{align*}
g_{d}^{2}+g_{m}^{2} & =(g_{c}-\Delta g)^{2}+(g_{c}+\Delta g)^{2}\\
 & =2g_{c}^{2}+2(\Delta g)^{2}\\
 & \ge2g_{c}^{2}.
\end{align*}

This shows that $var(G_{c})\le var(G_{p})$ and a similar argument
shows $var(S_{c})\le var(S_{p})$. Thus the covariance is higher (and
positive) in the children's generation, while the variances are lower.
Combining these ensures that 

\[
corr(G_{c},S_{c}) \ge corr(G_{p},S_{p}).
\]

Since for any $k$, either $var(G_{c}) < var(G_{p})$ or $var(S_{c}) < var(S_{p})$,
the only way to get strict equality for the above is if $k \in \{0,1\}$
and $cov(G_{c}, S_{c}) = cov(G_{p},S_{p}) = 0$.

\end{proof}
```
To show that the condition in the second part cannot be relaxed further,
consider the distribution in Figure
\ref{fig:Correlation-counterexample}. There is negative correlation in
the parents' generation (the shaded area). If $k = 1$ or is close enough
to 1, then assortative mating along the dotted lines will reduce the
variance of $S$ along those lines, pushing the distribution towards the
darker central area, without affecting the covariance. This will make
the correlation more negative. After repeated generations the horizontal
variance within values of $G$ will almost disappear and the correlation
will approach -1.

```{=tex}
\begin{figure}
\begin{centering}
\includegraphics[width=0.5\columnwidth]{correlation-counterexample}
\par\end{centering}
\caption{Correlation counterexample\label{fig:Correlation-counterexample}}

\end{figure}
```
## Proposition \ref{prop:robustness}

```{=tex}
\begin{proof}

Note that in proposition \ref{prop:prop1}, we took $g_{c(i)} = \bar{g}_{i}$ and $s_{c(i)} = \bar{s}_i$. Write 

\begin{align}
cov(G_{c},S_{c}) & =cov(\bar{G}+\varepsilon^{G},\bar{S}+\varepsilon^{S})\nonumber \\
 & = cov(\bar{G},\bar{S}) + cov(\varepsilon^{G},\bar{S}) + 
     cov(\bar{G},\varepsilon^{S}) + cov(\varepsilon^{G},\varepsilon^{S}).
 \label{eq:cov-with-error}
\end{align}

For any $X$ and $Y$, $cov(X, Y)$ is bounded by $\sqrt{var(X) var(Y)}$.
Plugging $\sigma_{G}^{2}$ and $\sigma_{S}^{2}$ into this formula
shows that under condition 1, $cov(G_{c},S_{c})$ will be arbitrarily
close to $cov(\bar{G},\bar{S})$. Similarly, writing

\[
var(G_{c}) = var(\bar{G}) + var(\varepsilon^{G}) + 2cov(\bar{G},\varepsilon^{G})
\]

shows that $var(G_{c})$ will approach $var(\bar{G})$ as $\sigma_{G}^{2}$
grows small, and similarly for $var(S_{c})$. Plugging these facts
into (\ref{eq:corr-cov-var}) shows that $corr(G_{c},S_{c})$ approaches
$corr(\bar{G},\bar{S})$ as $\sigma_{G}^{2}$ and $\sigma_{S}^{2}$
grow small. Proposition 1 then shows $corr(\bar{G},\bar{S}) < corr(G_{p},S_{p})$
for $k\in(0,1)$.

Under condition 2, $cov(G_{c}, S_{c}) = cov(\bar{G},\bar{S})$ since
the last three terms of the sum in (\ref{eq:cov-with-error}) are
zero. Then since 
\[
cov(\bar{G},\bar{S})\ge cov(G_{p},S_{p}) = 0
\]
with strict inequality iff $k\in(0,1)$, the covariance signs the
correlation. 

\end{proof}
```
\FloatBarrier

\newpage

## Robustness checks

```{r tbl-bo-no-fath-age}


age_table <- famhist %>% 
      filter(n_sibs >=2, n_sibs <= 8, ! is.na(birth_order)) %>% 
      group_by(n_sibs, birth_order) %>% 
      dplyr::summarize(
        N   = n(), 
        mfa = mean(fath_age_birth, na.rm = TRUE),
        mma = mean(moth_age_birth, na.rm = TRUE),
        .groups = "drop"
      )

mf_pairs_reg_big <- mf_pairs_twice %>% 
                  filter(
                    n_sibs.x >= 2, 
                    n_sibs.x <= 8, 
                    ! is.na(birth_order.x),
                    ! is.na(university.x),
                    ! is.na(first_job_pay.x)
                  )

fml_bo_no_fath_age <- lapply(fml_bo_psea, update, 
                     . ~ . - fath_age_birth.x, 
                     rhs = 1
                   )
mod_bo_no_fath_age <- lapply(fml_bo_no_fath_age, fixest::feols,
                     data  = mf_pairs_reg_big, 
                     notes = FALSE
                   )

fml_bo_moth_age <- lapply(fml_bo_no_fath_age, update, 
                     . ~ . + moth_age_birth.x, 
                     rhs = 1
                   )
mod_bo_moth_age <- lapply(fml_bo_moth_age, fixest::feols,
                     data  = mf_pairs_reg_big, 
                     notes = FALSE
                   )

huxreg(mod_bo_no_fath_age, 
        coefs = c(
          "Birth order"           = "birth_order.x", 
          "University"            = "university.xTRUE", 
          "Income"                = "first_job_pay.x", 
          "Own PSEA"               = "EA3.x",
          "Fluid IQ"              = "fluid_iq.x",
          "Self-rated health"     = "sr_health.x"
        ),
         note = "{stars}. Standard errors clustered by spouse pair.",
         tidy_args = list(conf.int = FALSE, cluster = list(mf_pairs_reg_big$couple_id))
       ) %>% 
       insert_row(after = 13, "Family size dummies", rep("Yes", 5)) %>% 
       insert_row(after = 14, "Birth month dummies", rep("Yes", 5)) %>% 
       insert_row(after = 15, "Birth year dummies", rep("Yes", 5)) %>% 
       set_bottom_border(14:15, everywhere, 0) %>% 
       set_number_format(2:13, -1, 4) %>% 
       set_caption("Regressions of spouse PSEA, without controls for father's age at respondent's birth")

```

```{r tbl-bo-psea-interactions}

fml_bo_psea_ix <- fml_bo_psea %>% 
                    purrr::map(update, 
                               . ~ . - birth_order.x + birth_order.x:factor(n_sibs.x),
                                 rhs = 1 
                               )

mod_bo_psea_ix <-  purrr::map(fml_bo_psea_ix, fixest::feols, 
                         data = mf_pairs_reg,
                         notes = FALSE
                       )


huxreg_coefs <- grep(":", names(coef(mod_bo_psea_ix[[1]])), value = TRUE)
names(huxreg_coefs) <- gsub(".*(\\d)$", "Birth order X family size \\1",
                            huxreg_coefs)
huxreg_coefs <- c(
                   huxreg_coefs,
                   "University"  = "university.xTRUE", 
                   "Income"      = "first_job_pay.x", 
                   "Own EA3"     = "EA3.x"
                 )

huxtable::huxreg(mod_bo_psea_ix, 
                   coefs = huxreg_coefs,
                   note = "{stars}. Standard errors clustered by spouse pair.",
                   tidy_args = list(
                     conf.int = FALSE, 
                     cluster = list(mf_pairs_reg$couple_id)
                   )
                 ) %>% 
       insert_row(after = 21, "Family size dummies", rep("Yes", 5)) %>% 
       insert_row(after = 22, "Birth month dummies", rep("Yes", 5)) %>% 
       insert_row(after = 23, "Birth year dummies", rep("Yes", 5)) %>% 
       set_bottom_border(22:23, everywhere, 0) %>% 
       set_number_format(2:21, -1, 4) %>% 
       set_caption("Regressions of spouse PSEA, separate birth order coefficients for each family size") %>% 
       set_font_size(10)

```

```{r tbl-bo-psea-robust}

fml_bo_psea_robust <- fml_bo_psea %>% 
                        purrr::map(update, 
                           . ~ . + 
                           bmi_combined_resid.x + 
                           conscientiousness_resid.x + 
                           neuroticism_resid.x
                        )

mod_bo_psea_robust <-  purrr::map(fml_bo_psea_robust, fixest::feols, 
                         data = mf_pairs_reg,
                         notes = FALSE
                       )

huxreg(mod_bo_psea_robust, 
         coefs = c(
           "Birth order"           = "birth_order.x", 
           "University"            = "university.xTRUE", 
           "Income"                = "first_job_pay.x",
           "Father's age at birth" = "fath_age_birth.x",
           "Own PSEA"              = "EA3.x",
           "Fluid IQ"              = "fluid_iq.x",
           "Self-rated health"     = "sr_health.x"
         ),
         statistics = c(
           "N" = "nobs", 
           "R2" = "r.squared"
         ),
         note = "{stars}. Standard errors clustered by spouse pair. 
                 Polygenic scores: BMI, conscientiousness, neuroticism.",
         tidy_args = list(conf.int = FALSE, cluster = mf_pairs_reg$couple_id)
       ) %>% 
       insert_row(after = 15, "Family size dummies", rep("Yes", 5)) %>% 
       insert_row(after = 16, "Birth month dummies", rep("Yes", 5)) %>% 
       insert_row(after = 17, "Age quadratic", rep("Yes", 5)) %>% 
       insert_row(after = 18, "Polygenic score controls", rep("Yes", 5)) %>% 
       set_top_border(17:19, everywhere, 0) %>% 
       set_number_format(2:15, -1, 4) %>% 
       set_width(1) %>% 
       set_wrap(final(1), everywhere, TRUE) %>% 
       set_caption("Regressions of spouse PSEA with controls for polygenic scores")
```

\FloatBarrier

\newpage

## Quotations on natural inequality

...your face and figure have nothing of the slave about them, and
proclaim you of noble birth.

-- *Odyssey*, Odysseus to Laertes

Citizens, we shall say to them in our tale, you are brothers, yet God
has framed you differently. Some of you have the power of command, and
in the composition of these he has mingled gold, wherefore also they
have the greatest honour; others he has made of silver, to be
auxiliaries; others again who are to be husbandmen and craftsmen he has
composed of brass and iron; and the species will generally be preserved
in the children. But as all are of the same original stock, a golden
parent will sometimes have a silver son, or a silver parent a golden
son.

-- Plato *Republic*

Nature would like to distinguish between the bodies of freemen and
slaves, making the one strong for servile labor, the other upright, and
although useless for such services, useful for political life in the
arts both of war and peace. But the opposite often happens -- that some
have the souls and others have the bodies of freemen.

-- Aristotle *Politics*

Sons have no richer endowment than the quality

A noble and brave father gives in their begetting.

-- Euripides *Heracleidae*

His looks are full of peaceful majesty,

His head by nature fram'd to wear a crown,

His hands to wield a sceptre....

-- Shakespeare *Henry VI Part 3*

A daughter of a green Grocer, walks the Streets in London dayly with a
baskett of Cabbage Sprouts, Dandelions and Spinage on her head. She is
observed by the Painters to have a beautiful Face, an elegant figure, a
graceful Step and a debonair. They hire her to Sitt. She complies, and
is painted by forty Artists, in a Circle around her. The Scientific Sir
William Hamilton outbids the Painters, Sends her to Schools for a
genteel Education and Marries her. This Lady not only causes the
Tryumphs of the Nile of Copenhagen and Trafalgar, but Seperates Naples
from France and finally banishes the King and Queen from Sicilly. Such
is the Aristocracy of the natural Talent of Beauty.

-- John Adams to Thomas Jefferson, on Emma Hamilton

\newpage

# References
