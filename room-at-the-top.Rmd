---
title: 'Room at the top: biological lock-in of social advantage'
author: David Hugh-Jones & Abdel Abdellaoui
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2:
    toc: false
    latex_engine: xelatex
editor_options: 
  chunk_output_type: console
header-includes:
  - \usepackage{subfig}
---

```{r setup, include=FALSE}
library(drake)
library(dplyr)
library(magrittr)
library(AER)
library(ggplot2)
library(Hmisc)
library(huxtable)
library(broom)
library(fixest)
library(santoku)

knitr::opts_chunk$set(echo = FALSE)

drake::loadd(mf_pairs)
drake::loadd(famhist)
drake::loadd(resid_scores)

famhist %<>% left_join(resid_scores, by = "f.eid")
rm(resid_scores)

famhist$EA3 <- famhist$EA3_excl_23andMe_UK_resid
mf_pairs$EA3.m <- mf_pairs$EA3_excl_23andMe_UK_resid.m
mf_pairs$EA3.f <- mf_pairs$EA3_excl_23andMe_UK_resid.f


# for clustering and other stuff:
mf_pairs$couple_id <- paste(mf_pairs$ID.m, mf_pairs$ID.f, sep = "_")
mf_pairs$x <- "Male"
mf_pairs_rebadged <- mf_pairs
mf_pairs_rebadged$x <- "Female"
names(mf_pairs_rebadged) <- sub("\\.f$", ".mxxx", names(mf_pairs_rebadged))
names(mf_pairs_rebadged) <- sub("\\.m$", ".f", names(mf_pairs_rebadged))
names(mf_pairs_rebadged) <- sub("\\.mxxx$", ".m", names(mf_pairs_rebadged))

mf_pairs_twice <- bind_rows(mf_pairs, mf_pairs_rebadged)
names(mf_pairs_twice) <- sub("\\.m", ".x", names(mf_pairs_twice))
names(mf_pairs_twice) <- sub("\\.f", ".y", names(mf_pairs_twice))
rm(mf_pairs_rebadged)

theme_set(theme_minimal())
```

## Introduction

Charles Murray (1995) warned of "a merging of the cognitive elite with the
affluent". On the opposite side of the political spectrum, Karl Marx (1844)
wrote "I am ugly, but I can buy the most beautiful woman. Which means to say
that I am not ugly, for the effect of ugliness, its repelling power, is
destroyed by money." These quotations suggest that social advantages, such as
wealth, caste or status, may be transformed into biological advantages in the
next generation, via assortative mating between socially and genetically
advantaged people. We call this process *biological lock-in*.

Figure \@ref(fig:pic-basic-corr) illustrates the idea using data for spouse
pairs from UK Biobank. It plots one partner's mean polygenic score for
educational attainment (EA3) against the other partner's actual educational
attainment: possession of a university degree. University graduates had spouses
with higher EA3.^[To minimize concerns about genetic stratification, i.e.
correlations between genetics and non-genetic forms of inherited advantage, EA3
is residualized by the first 100 principal components of UK Biobank array data.]


```{r pic-basic-corr, fig.subcap = c("Male EA3 by female educational attainment", "Female EA3 by male educational attainment"), fig.cap = "Social and genetic advantage among spouse pairs in UK Biobank", fig.width = 3}

pic_ss <- stat_summary(fun.data = mean_cl_normal, geom = "pointrange")
pic_cc <- coord_cartesian(ylim = c(0, 0.2))

mf_pairs %>% 
      filter(! is.na(university.m)) %>% 
      ggplot(aes(university.m, EA3.f)) + 
        pic_ss + pic_cc

mf_pairs %>% 
      filter(! is.na(university.f)) %>% 
      ggplot(aes(university.f, EA3.m)) + 
        pic_ss + pic_cc
        
```

However, Figure \@ref(fig:pic-basic-corr) is not enough to prove biological
lock-in. It could be that one spouse's educational attainment reflects their own
genetic endowment, and that assortative mating takes place on the basis of
genetics alone, without any role for social advantage. For example, this might
happen if potential marriage partners are good at predicting each other's
genetics (via their phenotype) and are only motivated to
select partners on the basis of their genetic characteristics. 

To demonstrate biological lock-in, we therefore need a source of social
advantage which is exogenous to genetics. One possibility is *birth order*.
It is well known that earlier-born children receive more parental care and
have better life outcomes. (XXX is it? Go check.) On the other hand, early-
and late-born full siblings have the same *ex ante* expected genetic endowment.
^[This might not be the case, if parents' choice of whether to
have more children is endogenous to the genetic endowment of their earlier 
children. We will check for this below.] We can therefore use birth order
as an instrument for social advantage.

## TODO: reduced form


```{r pic-bo-university}
famhist %>% 
      filter(n_sibs <= 4, n_sibs >= 2, ! is.na(n_older_sibs)) %>% 
      mutate(
        `Birth order` = n_older_sibs + 1,
        `Family size` = n_sibs
      ) %>% 
      group_by(`Birth order`, `Family size`) %>% 
      dplyr::summarize(University = mean(university, na.rm = TRUE)) %>% 
      ggplot(aes(`Birth order`, University)) + 
      geom_col() +
      facet_grid(cols = vars(`Family size`), labeller = label_both) + 
      ylim(0, 0.15) 

```


```{r pic-bo-income}
famhist %>% 
      filter(
        n_sibs <= 4, 
        n_sibs >= 2, 
        ! is.na(n_older_sibs), 
        ! is.na(income_cat)
      ) %>% 
      mutate(
        `Birth order` = n_older_sibs + 1,
        `Family size` = n_sibs,
        `Income category` = factor(income_cat)
      ) %>% 
      ggplot(aes(`Birth order`, fill = `Income category`)) + 
      geom_bar(position = "fill") +
      facet_grid(cols = vars(`Family size`), labeller = label_both) + 
      scale_fill_brewer() + labs(y = "Proportion")
```


```{r}

famhist$birth_sun_s <- c(scale(famhist$birth_sun))

famhist$birth_lat_10k <- santoku::chop_width(famhist$birth_lat.0.0, 10000)
famhist$birth_lon_10k <- santoku::chop_width(famhist$birth_lon.0.0, 10000)
famhist$birth_lat_50k <- santoku::chop_width(famhist$birth_lat.0.0, 50000)
famhist$birth_lon_50k <- santoku::chop_width(famhist$birth_lon.0.0, 50000)

 

mod_uni_sun <- mod_income_sun <- mod_ea3_sun <- list()

# subset arg to lm doesn't work for poly(), which can't deal with NA values:
mod_uni_sun$poly <- famhist %>% 
                      filter(! is.na(birth_lat.0.0), ! is.na(birth_lon.0.0)) %>% 
                      {fixest::feglm(university ~ 
                                    birth_sun_s + 
                                    poly(birth_lat.0.0, birth_lon.0.0, degree = 5) |
                                    factor(birth_year) + 
                                    factor(birth_mon), 
                                  data   = .,
                                  family = "binomial"
                                )}

mod_income_sun$poly <- famhist %>% 
                        filter(! is.na(birth_lat.0.0), ! is.na(birth_lon.0.0)) %>% 
                        {lm(income_cat ~ 
                                      birth_sun_s + 
                                      poly(birth_lat.0.0, birth_lon.0.0, degree = 5) +
                                      factor(birth_year) + 
                                      factor(birth_mon), 
                                    data = .
                        )}

mod_ea3_sun$poly <- famhist %>% 
                      filter(! is.na(birth_lat.0.0), ! is.na(birth_lon.0.0)) %>% 
                      {lm(EA3 ~ 
                                    birth_sun_s + 
                                    poly(birth_lat.0.0, birth_lon.0.0, degree = 5) +
                                    factor(birth_year) + 
                                    factor(birth_mon), 
                                  data = .
                      )}

mod_uni_sun$fe50 <- fixest::feglm(
                      university ~ 
                      birth_sun_s | 
                      factor(birth_year) + 
                      factor(birth_mon) +
                      birth_lat_50k^birth_lon_50k,
                      data   = famhist,
                      family = "binomial"
                   )

mod_income_sun$fe50 <- fixest::feols(
                          income_cat ~ 
                          birth_sun_s | 
                          factor(birth_year) + 
                          factor(birth_mon) +
                          birth_lat_50k^birth_lon_50k,
                          data = famhist
                       )

mod_ea3_sun$fe50 <- fixest::feols(
                          EA3 ~ 
                          birth_sun_s | 
                          factor(birth_year) + 
                          factor(birth_mon) +
                          birth_lat_50k^birth_lon_50k,
                          data = famhist
                       )

mod_uni_sun$fe10 <- fixest::feglm(
                      university ~ 
                      birth_sun_s | 
                      factor(birth_year) +
                      factor(birth_mon) +
                      birth_lat_10k^birth_lon_10k,
                      data   = famhist,
                      family = "binomial"
                   )

mod_income_sun$fe10 <- fixest::feols(
                          income_cat ~ 
                          birth_sun_s | 
                          factor(birth_year) + 
                          factor(birth_mon) +
                          birth_lat_10k^birth_lon_10k,
                          data = famhist
                       )

mod_ea3_sun$fe10 <- fixest::feols(
                          EA3 ~ 
                          birth_sun_s | 
                          factor(birth_year) + 
                          factor(birth_mon) +
                          birth_lat_10k^birth_lon_10k,
                          data = famhist
                       )

huxreg(mod_uni_sun, 
        coefs = c("Sunshine" = "birth_sun_s"),
        tidy_args = list(se = "white")
      ) %>% 
      insert_row(after = 3, "Geography", "Polynomial", "50k dummies", "10k dummies") %>% 
      set_number_format(4, everywhere, NA)

huxreg(mod_income_sun, 
        coefs = c("Sunshine" = "birth_sun_s"),
        tidy_args = list(se = "white")
      ) %>% 
      insert_row(after = 3, "Geography", "Polynomial", "50k dummies", "10k dummies") %>% 
      set_number_format(4, everywhere, NA)

huxreg(mod_ea3_sun, 
        coefs = c("Sunshine" = "birth_sun_s"),
        tidy_args = list(se = "white")
      ) %>% 
      insert_row(after = 3, "Geography", "Polynomial", "50k dummies", "10k dummies") %>% 
      set_number_format(4, everywhere, NA)
```

## Regressions

We run regressions instrumenting one spouse's educational attainment with their
birth order. We control for overall family (i.e. sibling group)
size. Without this, then birth order would correlate with family size,
which itself may correlate with genetics, since parents of different family sizes
might have different genetic endowments. Indeed, respondents with more siblings
overall have substantially lower EA3. We also control for subject's own EA3. Lastly,
we allow the effect of birth order to vary depending on total family size.

Table \@ref(tab:tbl-instruments) shows instrumental variables regressions
using 2 stage least squares. We use only subjects with between 2 and 8 siblings. 
Column 1 pools men and women. Columns 2 and 3 run separate regressions by sex.
The effect is positive for both male and female subjects, but twice as strong, 
and significant, for males. 


```{r tbl-instruments}

mod_ea3_iv <- AER::ivreg(
                 EA3.f ~ university.m + factor(n_sibs.m) + EA3.m | 
                 n_older_sibs.m:factor(n_sibs.m) + factor(n_sibs.m) + EA3.m, 
                 data = mf_pairs_twice, 
                 subset = n_sibs.m >= 2 & n_sibs.m <= 8
               )

mod_ea3f_iv <- AER::ivreg(
                 EA3.f ~ university.m + factor(n_sibs.m) + EA3.m | 
                 n_older_sibs.m:factor(n_sibs.m) +factor(n_sibs.m) + EA3.m, 
                 data = mf_pairs, 
                 subset = n_sibs.m >= 2 & n_sibs.m <= 8
               )


mod_ea3m_iv <- AER::ivreg(
                 EA3.m ~ university.f + factor(n_sibs.f) + EA3.f | 
                 n_older_sibs.f:factor(n_sibs.f) + factor(n_sibs.f)  + EA3.f, 
                 data = mf_pairs, 
                 subset = n_sibs.f >= 2 & n_sibs.f <= 8
               )

# TODO: work out how to use coeftest and clustered vcov with ivreg
# 
mod_ea3_iv_or <- huxtable::tidy_override(mod_ea3_iv, extend = TRUE,
                 glance = as.list(glance(mod_ea3_iv, 
                 diagnostics = TRUE)))
mod_ea3f_iv_or <- huxtable::tidy_override(mod_ea3f_iv, extend = TRUE,
                 glance = as.list(glance(mod_ea3f_iv, 
                 diagnostics = TRUE)))
mod_ea3m_iv_or <- huxtable::tidy_override(mod_ea3m_iv,  extend = TRUE,
                 glance = as.list(glance(mod_ea3m_iv, 
                 diagnostics = TRUE)))
                                 
huxreg(
        "All spouses' EA3"    = mod_ea3_iv_or,
        "Female spouses' EA3" = mod_ea3f_iv_or, 
        "Male spouses' EA3"   = mod_ea3m_iv_or,
        coefs = c(
          "University" = "university.mTRUE", 
          "University" = "university.fTRUE",
          "EA3"        = "EA3.m",
          "EA3"        = "EA3.f"
        ),
        statistics = c(
          "R2"              = "r.squared", 
          "N"               = "nobs",
          "Sargan test (p)" = "p.value.Sargan"
        ),
        note = "{stars}. Educational attainment instrumented by birth order."
      ) %>% 
      insert_row(c("Family size dummies", "Y", "Y", "Y"), after = 5) %>% 
      set_caption("Effects of educational attainment on spouse's EA3")
```


```{r}
mod_ea3_check <- lm(EA3 ~ 0 + factor(n_sibs) + n_older_sibs:factor(n_sibs), 
                    famhist, n_sibs >= 2 & n_sibs <= 8)
av <- tidy(car::Anova(mod_ea3_check)) 
av_pval <- av %>% 
              filter(term == "factor(n_sibs):n_older_sibs") %>% 
              pull(p.value)
```


Although all children of the same parents have identical expected values of
polygenic scores, it is conceivable that parents might select family size
on the basis of genetics. For example, if the first child had a phenotype
reflecting a high (or low) polygenic score, then that might
affect the parents' decision to have a second child. To check this we 
regress birth order directly on EA3. As before, we control for family size
and allow the effect of birth order to vary depending on family size.
Birth order variables are not jointly significant (anova p 
`r round(av_pval, 3)`) and their effect sizes are of the order of 0.01 of a 
standard deviation of EA3.



